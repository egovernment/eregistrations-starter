'use strict';

var $        = require('./main')
  , once     = require('timers-ext/once')
  , addEvent = require('./element#/event').addEvent
  , forEach  = require('./for-each')

  , propagate;

module.exports = $;

$.onEnvUpdate = function (dom, cb) {
	dom = (dom == null) ? document : $(dom);
	cb = once(cb, 0);
	if (!dom._mano$envUpdateCb) dom._mano$envUpdateCb = [];
	dom._mano$envUpdateCb.push(cb);
	addEvent.call(dom, 'keyup', cb);
	addEvent.call(dom, 'click', cb);
	addEvent.call(dom, 'change', cb);
	addEvent.call(dom, 'reset', function () { setTimeout(cb, 0); });
	if (document.on) document.on('db-update', cb);
	cb();
	return cb;
};

propagate = $.propagateEnvUpdate = function (el) {
	forEach(el.childNodes, function (child) {
		if (child.childNodes) propagate(child);
	});

	if (el._mano$envUpdateCb) {
		forEach(el._mano$envUpdateCb, function (cb) { cb(); });
	}
};
