'use strict';

var $       = require('./main')
  , forEach = require('./for-each');

require('./element#/class');

module.exports = $.getCheckboxLimiter = function (checkboxes, limit) {
	var current = [], name, map = {};
	forEach(checkboxes, function (checkbox) { map[checkbox.value] = $(checkbox); });
	return function () {
		var nu = [], i;
		forEach(checkboxes, function (checkbox) {
			if (checkbox.checked) nu.push(checkbox.value);
		});
		if (nu.length <= limit) {
			current = nu;
			return;
		}
		forEach(current.slice(), function (name, i) {
			var index = nu.indexOf(name);
			if (index === -1) {
				current.splice(i, 1);
				return;
			}
			nu.splice(index, 1);
		});
		current.push.apply(current, nu);
		i = 0;
		while (current.length > limit) {
			name = current[i];
			if ((map[name].disabled || map[name].hasClass('readonly')) && (i < limit)) {
				++i;
				continue;
			}
			current.splice(i, 1);
			map[name].checked = false;
		}
	};
};
