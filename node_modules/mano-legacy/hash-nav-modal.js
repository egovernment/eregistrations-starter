'use strict';

var $                = require('./main')
  , hashNav          = require('./hash-nav')
  , events           = require('./element#/event')
  , isInElement      = require('./element-in-element-inclusive')
  , centerInViewport = require('./center-in-viewport')

  , currentModal, onUpdate;

var isHistorySupported = ((typeof window.history === 'object') && window.history &&
	(typeof window.history.pushState === 'function'));

require('./element#/class');

hashNav.on('update', onUpdate = function (nu) {
	if (!nu || !nu.hasClass('dialog-modal')) {
		if (!currentModal) return;
		$(document.body).removeClass('dialog-modal-on');
		document.body.addClass('dialog-modal-off');
		currentModal = null;
		return;
	}
	if (!currentModal) {
		$(document.body).removeClass('dialog-modal-off');
		document.body.addClass('dialog-modal-on');
	}
	currentModal = nu;
	if (!nu.hasClass('dialog-modal-custom-position')) centerInViewport(nu);
});
onUpdate(hashNav.getCurrentTarget());

events.addEvent.call(document, 'click', function (event) {
	var target, nuUrl;
	if (!currentModal) return;
	target = event.target || event.srcElement;
	if (isInElement(target, currentModal)) return;
	nuUrl = location.pathname + location.search;
	if (isHistorySupported) window.history.pushState({}, '', nuUrl);
	else location.href = nuUrl;
}, true);
