'use strict';

var $              = require('./main')
  , proto          = require('./element#/main')
  , getUpdateByMap = require('./_get-update-by-map')
  , getValue;

require('./element#/event');

getValue = function (container, name) {
	var i, input, controls = container.getElementsByTagName('input'), exists;
	for (i = 0; (input = controls[i]); ++i) {
		if (input.name !== name) continue;
		exists = true;
		if (input.checked) return input.value;
	}
	return exists ? null : undefined;
};

module.exports = $.radioMatch = function (container, name, map) {
	var update = getUpdateByMap(map), isInitialized, onChange;
	var initialize = function (container) {
		container.addEvent('click', function () { setTimeout(onChange, 50); });
		isInitialized = true;
	};
	onChange = function () {
		var el, value;
		el = $(container);
		if (!el) return;
		if (!isInitialized) initialize(el);
		value = getValue(el, name);
		if (value === undefined) return;
		update(value);
	};
	proto.addEvent.call(document, 'change', onChange);
	if (document.on) {
		document.on('pageload', onChange);
		document.on('db-update', onChange);
	}
	onChange();
	return onChange;
};
