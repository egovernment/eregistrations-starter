'use strict';

var $          = require('./main')
  , forEach    = require('./for-each')
  , proto      = require('./element#/main')
  , isArray    = require('./is-array')
  , inDocument = require('./element-in-document');

require('./element#/event');
require('./element#/toggle');

module.exports = $.checkboxToggle = function (checkbox, controls) {
	var onChange, current, update, resolve;

	resolve = function (id, method) {
		var el;
		if ((typeof id === 'string') && (id.charAt(0) === '!')) {
			id = id.slice(1);
			method = !method;
		}
		el = $(id);
		if (el) el.toggle(method);
	};

	update = isArray(controls) ? function (visible) {
		forEach(controls, function (control) { resolve(control, visible); });
	} : function (visible) {
		resolve(controls, visible);
	};
	proto.addEvent.call(document, 'change', onChange = function () {
		var el, nu;
		el = $(checkbox);
		if (!el) nu = false;
		else nu = el.checked && inDocument(el);
		if (nu === current) return;
		update(current = nu);
	});
	if (document.on) {
		document.on('pageload', onChange);
		document.on('db-update', onChange);
	}
	onChange();
	return onChange;
};
