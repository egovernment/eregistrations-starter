'use strict';

var forEach        = require('es5-ext/object/for-each')
  , startsWith     = require('es5-ext/string/#/starts-with')
  , genId          = require('time-uuid')
  , genStamp       = require('time-uuid/time')
  , serializeKey   = require('dbjs/_setup/serialize/key')
  , serializeValue = require('dbjs/_setup/serialize/value')

  , isArray = Array.isArray;

module.exports = function (data, path) {
	var id = genId()
	  , re = new RegExp('^' + path)
	  , records = [
		{ id: id, data: { value: 7 + path, stamp: genStamp() } }
	];

	forEach(data, function (value, key) {
		var recordId;
		if (!startsWith.call(key, path + '/')) return;
		recordId = key.replace(re, id);
		if (isArray(value)) {
			value.forEach(function (value) {
				records.push({
					id: recordId + '*' + serializeKey(value),
					data: { value: '11', stamp: genStamp.increment() }
				});
			});
		} else {
			records.push({
				id: recordId,
				data: { value: serializeValue(value), stamp: genStamp.increment() }
			});
		}
	});
	return { id: id, records: records };
};
