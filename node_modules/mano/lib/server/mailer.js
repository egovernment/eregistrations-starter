'use strict';

var validValue = require('es5-ext/object/valid-value')
  , deferred   = require('deferred')
  , nodemailer = require('nodemailer')

  , promisify = deferred.promisify
  , transport, from, subjectPrefix, logOnly, bcc;

module.exports = exports = function (data) {
	if (!logOnly && !transport) throw new Error('SMTP settings not configured');
	validValue(data);
	if (!data.subject) throw new Error("'subject' not provided");
	data.subject = subjectPrefix + String(data.subject);
	if (!data.text && !data.html) throw new Error("content not provided");
	if (data.text) data.text = String(data.text);
	if (data.html) data.html = String(data.html);
	if (data.from == null) data.from = from;
	if (bcc) {
		if (data.bcc) data.bcc += ", " + bcc;
		else data.bcc = bcc;
	}
	console.log("Send email", data);
	if (logOnly) return deferred(null);
	return transport.sendMail(data);
};

exports.setup = function (smtp) {
	exports.config = smtp;
	subjectPrefix = smtp.subjectPrefix || '';
	from = smtp.from;
	logOnly = smtp.logOnly;
	bcc = smtp.bcc;
	if (!logOnly) {
		transport = nodemailer.createTransport(smtp);
		transport.sendMail = promisify(transport.sendMail);
	}
	exports.configured = true;
	return exports;
};
