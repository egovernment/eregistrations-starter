'use strict';

var deferred = require('deferred')
  , ee       = require('event-emitter')
  , memoize  = require('memoizee/plain')
  , db       = require('mano').db;

var registerUser = memoize(function (userId) {
	var user = db.User.getById(userId);
	if (!user) return null;
	user._appAccessId.on('change', function (event) { exports.emit(userId, event.newValue); });
	return user;
});

ee(exports);

exports.get = function (userId) {
	var user = registerUser(userId);
	return deferred(user ? user.appAccessId : userId);
};
