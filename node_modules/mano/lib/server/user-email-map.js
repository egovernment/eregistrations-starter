'use strict';

var Map            = require('es6-map')
  , deferred       = require('deferred')
  , getReverseMap  = require('eregistrations/server/utils/get-db-reverse-map')
  , driver         = require('mano').dbDriver
  , serializeValue = require('dbjs/_setup/serialize/value')
  , _              = require('mano').i18n.bind("Authentication")
  , customError    = require('es5-ext/error/custom')

  , map;

if (!driver) {
	// Prototype app needs such handling
	console.log("No db driver registered");
	console.log("Initialized dummy email map");
	map = deferred(new Map());
} else {
	map = getReverseMap(driver.getStorage('user'), 'email');
}

map.ensureUniq = function (value) {
	return this(function (result) {
		if (result.has(serializeValue(value))) {
			throw customError(_("There is already an account registered for that email address"), {
				fieldName: 'User#/email',
				statusCode: 400
			});
		}
		return value;
	});
};

module.exports = map;
