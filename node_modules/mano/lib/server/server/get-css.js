'use strict';

var endsWith     = require('es5-ext/string/#/ends-with')
  , debug        = require('debug-ext')('client-bundle')
  , getReadFile  = require('eregistrations/server/get-read-file')
  , normalBundle = require('eregistrations/server/css-bundle')
  , legacyBundle = require('eregistrations/server/css-legacy-bundle');

module.exports = function () {
	var bundleOptions = { readFile: getReadFile() };
	return function (req, res, next) {
		var url = req._parsedUrl.pathname, indexPath = this[url], bundle;

		if (!indexPath) {
			next();
			return;
		}

		res.setHeader('Content-Type', 'text/css; charset=utf-8 ');
		// Do not cache generated bundle
		res.setHeader('Cache-Control', 'no-cache');

		bundle = endsWith.call(url, '-legacy.css') ? legacyBundle : normalBundle;
		bundle(indexPath, bundleOptions).done(function (content) {
			// Send script
			res.end(content);
			debug("%s %s CSS Bundle OK", req.$clientWithSessionId, req.url);
		}, function (err) {
			debug("%s %s CSS Bundle Error", req.$clienWithSessiontId, req.url);
			console.error(err.stack);

			res.statusCode = 500;
			res.end("Cannot bundle CSS: " + err.stack);
		});
	};
};
