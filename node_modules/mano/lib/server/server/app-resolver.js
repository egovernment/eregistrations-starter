'use strict';

var startsWith       = require('es5-ext/string/#/starts-with')
  , debug            = require('debug-ext')('client')
  , unserializeValue = require('dbjs/_setup/unserialize/value')
  , appNameMap       = require('../user-app-name-map');

module.exports = function (req, res, next) {
	if (startsWith.call(req.$clientId, 'legacy_')) {
		req.$appName = req.$clientId.split('_', 2)[1];
		next();
		return;
	}
	if (!req.$user) {
		req.$appName = 'public';
		debug("%s %s %s %s %s %s", req.$clientWithSessionId, req.method, req.url,
			'[unauthenticated:' + (req.headers['user-agent'] || '') + ']', req.$appName,
			(new Date()).toISOString());
		next();
		return;
	}
	appNameMap.get(req.$user).done(function (appName) {
		req.$appName = unserializeValue(appName) || 'public';
		debug("%s %s %s %s %s %s", req.$clientWithSessionId, req.method, req.url,
			req.$user, req.$appName, (new Date()).toISOString());
		next();
	});
};
