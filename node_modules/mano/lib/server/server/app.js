'use strict';

var copy         = require('es5-ext/object/copy')
  , isEmpty      = require('es5-ext/object/is-empty')
  , path         = require('path')
  , stringify    = require('querystring').stringify
  , getHtmlIndex = require('../utils/get-html-index')
  , mano         = require('../../../')

  , extname = path.extname;

var redirect = function (req, res) {
	var query = copy(req.query), search;
	delete query.legacy;
	search = isEmpty(query) ? '' : '? ' + stringify(query);
	res.writeHead(302, { Location: req._parsedUrl.pathname + search });
	res.end();
};

module.exports = function (req, res, next) {
	var indexPath;

	if (extname(req._parsedUrl.pathname)) {
		next();
		return;
	}

	indexPath = this[req.$appName || 'main'];
	if (!indexPath) {
		next();
		return;
	}

	if (!req.cookies.get('legacyPool') && mano.legacyPool) {
		if (req.query.legacy === '0') {
			res.cookies.set('legacy', null, { httpOnly: false });
			redirect(req, res);
			return;
		}
		if (req.query.legacy === '1') {
			res.cookies.set('legacy', '1', { httpOnly: false });
			redirect(req, res);
			return;
		}
		if (req.$forceLegacy || req.cookies.get('legacy')) {
			mano.legacyPool(req, res);
			return;
		}
	}
	res.setHeader('X-UA-Compatible', 'IE=edge,chrome=1');
	res.setHeader('Content-Type', 'text/html; charset=utf-8');
	res.setHeader('Cache-Control', 'no-cache');
	getHtmlIndex(indexPath).done(res.end.bind(res));
};
