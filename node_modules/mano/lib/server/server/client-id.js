'use strict';

var timeUuid  = require('time-uuid')

  , expires = new Date(Date.now() + 5 * 365 * 24 * 60 * 60 * 1000);

module.exports = function (req, res, next) {
	var id = req.cookies.get('id'), clientSessionId;
	if (!id) {
		id = timeUuid();
		res.cookies.set('id', id, { expires: expires, httpOnly: false });
	}
	req.$clientId = id;
	if (req.headers['x-browser-session']) {
		clientSessionId = req.headers['x-browser-session'];
	} else if (req.query.csid) {
		clientSessionId = req.query.csid;
	}
	if (clientSessionId) {
		req.$clientSessionId = clientSessionId;
		req.$clientWithSessionId = id + ':' + clientSessionId;
	} else {
		req.$clientWithSessionId = id;
	}
	next();
};
