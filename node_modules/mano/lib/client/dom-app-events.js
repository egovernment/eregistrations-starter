'use strict';

var ee           = require('event-emitter')
  , once         = require('timers-ext/once')
  , db           = require('../../').db
  , serialize    = require('dbjs/_setup/serialize/value')
  , unserialize  = require('dbjs/_setup/unserialize/value')

  , onUpdate = once(function () { document.emit('db-update'); });

ee(document);

db.objects.on('update', function (event) {
	var value;
	if (event) {
		value = event.value;
		if ((value != null) && (typeof value === 'object')) {
			if (value._kind_ && value.hasOwnProperty('__id__')) value = value.__id__;
			else value = unserialize(serialize(value), db.objects);
		} else if (typeof value === 'function') {
			value = unserialize(serialize(value), db.objects);
		}
		document.emit('dbupdate', event);
		document.emit('db:' + event.object.__valueId__, value);
	}
	onUpdate();
});
