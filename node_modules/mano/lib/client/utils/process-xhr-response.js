'use strict';

var customError = require('es5-ext/error/custom')
  , location    = require('../location')
  , sse         = require('../sse-driver')
  , formStatus  = require('./form-status')

  , showError = formStatus.showError, showSuccess = formStatus.showSuccess;

module.exports = function (data) {
	var listener, timeout;
	if (data === 'OK') return;
	if (data) {
		if (data.message) {
			showSuccess.call(this, data.message);
			if (data.url) location.goto(data.url);
			return;
		}
		if (data.url) {
			if (data.inSync === false) {
				sse.once('sync', listener = function () {
					clearTimeout(timeout);
					if (data.reload) window.location.href = data.url;
					else location.goto(data.url);
				});
				timeout = setTimeout(function () {
					sse.off('sync', listener);
					if (data.reload) window.location.href = data.url;
					else location.goto(data.url);
				}, 15000);
				return;
			}
			if (data.reload) window.location.href = data.url;
			else location.goto(data.url);
			return;
		}
	}
	showError.call(this, customError("Invalid response",
		'INVALID_INSTRUCTION'));
};
