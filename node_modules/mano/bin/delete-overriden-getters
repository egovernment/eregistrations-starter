#!/usr/bin/env node

'use strict';

Error.stackTraceLimit = Infinity;

var resolve  = require('path').resolve
  , deferred = require('deferred')
  , columns  = require('cli-color/columns')
  , find     = require('../scripts/find-overriden-getters')

  , program = require('commander').usage('[options] [path]')
	.option('--ignores <ignores>', "Keys to ignore, provided as: foo,bar,lorem")
	.parse(process.argv)
  , ignores, count = 0;

if (program.ignores) {
	ignores = program.ignores.split(',').map(Function.prototype.call.bind(String.prototype.trim));
}

find(process.cwd(), { log: process.stdout.write.bind(process.stdout),
	ignores: ignores })(function (data) {
		var mongo = data.mongo;
		return deferred.map(data.result.map(function (data) {
			console.log("Delete:", data.mongoObject._id);
			++count;
			return mongo.delete(data.mongoObject._id);
		}))(function () {
			return mongo.close();
		});
	}).done(function () { console.log(count + " records in question removed"); });
