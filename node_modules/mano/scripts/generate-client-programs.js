'use strict';

var plainReplace = require('es5-ext/string/#/plain-replace')
  , deferred     = require('deferred')
  , resolve      = require('path').resolve
  , fs           = require('fs')
  , mkdir        = require('fs2/mkdir')
  , webmakeOrg   = require('webmake')
  , webmake      = require('../lib/server/webmake')
  , minify       = require('./minify')
  , resolveApps  = require('./resolve-apps')
  , resolveEnv   = require('./resolve-env')

  , promisify = deferred.promisify
  , opts = { intermediate: true }
  , stat = promisify(fs.stat), writeFile = promisify(fs.writeFile);

module.exports = function (path/*, name*/) {
	var env, name = arguments[1];
	return resolveEnv(path).aside(function (data) { env = data; })(function () {
		return resolveApps(path, name).map(function (app) {
			var promise;
			return mkdir(resolve(app.root, 'public'), opts)(function () {
				return deferred(writeFile(resolve(app.root, 'public/' + app.name + '.js'),
					promise = webmake(resolve(app.root, 'client/program.js'),
						resolve(app.root, app.viewPath || 'view'))(function (content) {
						if (env.minify === false) return content;
						return minify(content);
					})),
					stat(resolve(app.root, 'client/legacy.js'))('.js', function () {
						return stat(resolve(app.root, 'client/legacy/index.js'))('/index.js');
					})(function (path) {
						return writeFile(resolve(app.root, 'public/' + app.name + '.legacy.js'),
							webmakeOrg(resolve(app.root, 'client/legacy' + path),
								{ prettyOutput: false })(function (content) {
								content = plainReplace.call(content,
									'${BUILD_TIMESTAMP}', (new Date()).toISOString());
								if (env.minify === false) return content;
								return minify(content);
							}));
					}, function (err) {
						if (err.code === 'ENOENT') return null;
						throw err;
					}))(function () { return promise.parser; });
			});
		});
	});
};
