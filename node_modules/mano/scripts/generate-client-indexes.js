'use strict';

var deferred       = require('deferred')
  , resolve        = require('path').resolve
  , fs             = require('fs')
  , resolveApps    = require('./resolve-apps')
  , resolveEnv     = require('./resolve-env')
  , replaceEnvVars = require('../lib/utils/replace-env-vars')

  , promisify = deferred.promisify
  , readFile = promisify(fs.readFile), writeFile = promisify(fs.writeFile);

module.exports = function (path/*, name*/) {
	var env, name = arguments[1];
	return resolveEnv(path).aside(function (data) {
		env = data;
	})(resolveApps(path, name)).map(function (app) {
		var viewPath = resolve(app.root, app.viewPath || 'view');
		return readFile(resolve(viewPath, 'index.html'))(function (src) {
			return writeFile(resolve(viewPath, 'index.generated.html'),
				replaceEnvVars(src, env));
		});
	});
};
