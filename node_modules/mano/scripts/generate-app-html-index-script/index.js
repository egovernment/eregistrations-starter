// Copies index generation scripts into apps

'use strict';

var deferred        = require('deferred')
  , path            = require('path')
  , resolveTemplate = require('es6-template-strings')
  , readFile        = require('fs2/read-file')
  , writeFile       = require('fs2/write-file')
  , resolveRoot     = require('../../lib/resolve-root-at-app')

  , basename = path.basename, resolve = path.resolve
  , appProgramTplPath = resolve(__dirname, 'program.tpl')
  , appHtmlIndexTplPath = resolve(__dirname, 'index.html.tpl')
  , writeOpts = { intermediate: true }
  , writeOptsBin = { intermediate: true, mode: 493 }

  , appScriptName = 'generate-html-index';

module.exports = function (appPath/*, options*/) {
	return deferred(
		readFile(appHtmlIndexTplPath)(function (template) {
			return writeFile(resolve(appPath, 'index.html.tpl'),
				resolveTemplate(template, { appName: basename(appPath) },
					{ partial: true }), writeOpts);
		}),
		readFile(appProgramTplPath)(function (template) {
			return writeFile(resolve(appPath, 'bin', appScriptName),
				resolveTemplate(template, { rootDir: resolveRoot(appPath) }), writeOptsBin);
		})
	);
};
