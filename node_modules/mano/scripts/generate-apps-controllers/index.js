// Generates controllers configuration for all apps

'use strict';

var resolveTemplate = require('es6-template-strings')
  , path            = require('path')
  , readFile        = require('fs2/read-file')
  , writeFile       = require('fs2/write-file')

  , stringify = JSON.stringify
  , relative = path.relative, resolve = path.resolve
  , confTplPath = resolve(__dirname, 'controllers.js.tpl')

  , writeOpts = { intermediate: true };

module.exports = function (root, apps) {
	return readFile(confTplPath)(function (template) {
		var appsConf = '{\n\t' + apps.map(function (appPath) {
			var requirePath = relative('server/apps', appPath);
			if (requirePath[0] !== '.') requirePath = './' + requirePath;
			return stringify(appPath) + ': joinControllers(\n\t\t' +
				'require(' + stringify(requirePath + '/controller') + '),\n\t\t' +
				'require(' + stringify(requirePath + '/controller/server') + ')\n\t)';
		}).join(',\n\t') + '\n}';
		return writeFile(resolve(root, './server/apps/controllers.js'),
			resolveTemplate(template, { data: appsConf }), writeOpts);
	});
};
