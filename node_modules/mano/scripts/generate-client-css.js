'use strict';

var resolve      = require('path').resolve
  , deferred     = require('deferred')
  , stat         = require('fs2/stat')
  , writeFile    = require('fs2/write-file')
  , bundle       = require('eregistrations/server/css-bundle')
  , legacyBundle = require('eregistrations/server/css-legacy-bundle')
  , resolveApps  = require('./resolve-apps');

var generate = function (app, postfix) {
	var indexPath;
	if (!postfix) postfix = '';
	return stat(indexPath = resolve(app.root, 'client/css' + postfix + '.index'))(function (stats) {
		if (!stats.isFile()) return;
		return deferred(bundle(indexPath)(function (content) {
			return writeFile(resolve(app.root, 'public/' + app.name + postfix + '.css'), content,
				{ intermediate: true });
		}), !postfix && legacyBundle(indexPath)(function (content) {
			return writeFile(resolve(app.root, 'public/' + app.name + '-legacy.css'), content,
				{ intermediate: true });
		}));
	}, function (e) {
		if (e.code === 'ENOENT') return;
		throw e;
	});
};

module.exports = function (path/*, name*/) {
	var name = arguments[1];
	return resolveApps(path, name).map(function (app) {
		return deferred(generate(app), generate(app, '-print'));
	});
};
