// Generates app css files

'use strict';

var deferred     = require('deferred')
  , path         = require('path')
  , stat         = require('fs2/stat')
  , writeFile    = require('fs2/write-file')
  , bundle       = require('eregistrations/server/css-bundle')
  , legacyBundle = require('eregistrations/server/css-legacy-bundle')

  , basename = path.basename, resolve = path.resolve
  , writeOpts = { intermediate: true };

var isFile = function (path) {
	return stat(path)(function (stats) { return stats.isFile(); }, function (e) {
		if (e.code === 'ENOENT') return false;
		throw e;
	});
};

module.exports = function (appPath) {
	var appName = basename(appPath)
	  , indexPath = resolve(appPath, 'client/css.index')
	  , printIndexPath = resolve(appPath, 'client/css-print.index');

	return deferred(
		isFile(indexPath)(function (isFile) {
			if (!isFile) return;
			return deferred(
				bundle(indexPath)(function (content) {
					return writeFile(resolve(appPath, 'public/' + appName + '.css'), content, writeOpts);
				}),
				legacyBundle(indexPath)(function (content) {
					return writeFile(resolve(appPath, 'public/' + appName + '-legacy.css'), content,
						writeOpts);
				})
			);
		}),
		isFile(printIndexPath)(function (isFile) {
			if (!isFile) return;
			return bundle(printIndexPath)(function (content) {
				return writeFile(resolve(appPath, 'public/' + appName + '-print.css'), content, writeOpts);
			});
		})
	);
};
