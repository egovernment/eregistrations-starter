'use strict';

var value     = require('es5-ext/object/valid-value')
  , endsWith  = require('es5-ext/string/#/ends-with')
  , promisify = require('deferred').promisify
  , bcrypt    = require('bcrypt')
  , serialize = require('dbjs/_setup/serialize/value')
  , update    = require('./plain-dbjs-update')

  , genSalt = promisify(bcrypt.genSalt), hash = promisify(bcrypt.hash);

module.exports = function (root, newPassword/*, options*/) {
	value(newPassword);
	return update(value(root), function (id, value) {
		if (!endsWith.call(id, '/password')) return;
		return hash(newPassword, genSalt())(serialize);
	}, arguments[2]);
};
