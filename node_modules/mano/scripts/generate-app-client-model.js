// Generates optimised (fast loading) model file for a client

'use strict';

var primitiveSet   = require('es5-ext/object/primitive-set')
  , ensureString   = require('es5-ext/object/validate-stringifiable-value')
  , deferred       = require('deferred')
  , ensureDatabase = require('dbjs/valid-dbjs')
  , resolve        = require('path').resolve
  , mkdir          = require('fs2/mkdir')
  , exportSnapshot = require('./export-snapshot')
  , tagRelations   = require('./relation-tagger');

module.exports = function (database, appPath) {
	var options = { log: true };
	ensureString(appPath);
	if (ensureDatabase(database)._persistent_) {
		options.persistent = primitiveSet.apply(null, database._persistent_);
	}
	return deferred(
		exportSnapshot(database, resolve(appPath, 'client/model.generated.js'), options),
		mkdir(resolve(appPath, 'server'), { intermediate: true })(function () {
			return tagRelations(database, resolve(appPath, 'server/model-tags.generated.js'));
		})
	);
};
