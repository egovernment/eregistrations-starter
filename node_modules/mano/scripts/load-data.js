'use strict';

var noop        = require('es5-ext/function/noop')
  , callable    = require('es5-ext/object/valid-callable')
  , resolveEnv = require('./resolve-env')
  , loadSchema  = require('./load-schema')

  , now = Date.now;

module.exports = function (path/*, log*/) {
	var log = arguments[1], time;
	if (log == null) log = noop;
	else callable(log);

	log("Load schemas...");
	time = now();
	return loadSchema(path).aside(function () {
		log(" loaded in " + ((now() - time) / 1000).toFixed(2) + "s\n");
	})(resolveEnv(path))(function (env) {

		if (!env.db) return;
		log('Populate database...');
		return require('../lib/server/mongodb-dbjs')(env.db, log)
			.aside(function () { log(" populated\n\n"); });
	});
};
