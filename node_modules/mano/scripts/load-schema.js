'use strict';

var resolve     = require('path').resolve
  , DbjsEvent   = require('dbjs/_setup/event')
  , resolveApps = require('./resolve-apps')
  , tryRequire  = require('../lib/utils/try-require').bind(require)
  , db          = require('../');

module.exports = function (path/*, name*/) {
	DbjsEvent.stampZeroMode = true;
	db._postponed_ += 1;
	return resolveApps(path, arguments[1]).aside(function () {
		require('../lib/server/model');
	}).map(function (app) {
		tryRequire(resolve(app.root, 'model'));
	}).aside(function () {
		DbjsEvent.stampZeroMode = false;
		db._postponed_ -= 1;
	});
};
