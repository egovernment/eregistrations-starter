'use strict';

var ensureStringifiable = require('es5-ext/object/validate-stringifiable-value')
  , ws                  = require('esniff/lib/ws');

module.exports = function (html) {
	var index, quote, start, end, char, messages = {}, message;
	html = ensureStringifiable(html);
	index = html.indexOf('_(');
	while (index !== -1) {
		index += 2;
		while (ws[html[index]]) ++index;
		quote = html[index];
		if ((quote !== '"') && (quote !== '\'')) {
			index = html.indexOf('_(', index);
			continue;
		}
		start = index;
		while ((char = html[++index])) {
			if (char === '\\') {
				++index;
				continue;
			}
			if (char === quote) {
				end = index + 1;
				break;
			}
		}
		if (!end) break;
		message = new Function("'use strict'; return " + html.slice(start, end))().trim();
		if (!messages[message]) messages[message] = [];
		messages[message].push({ point: start });
	}
	return { context: 'default', messages: messages };
};
