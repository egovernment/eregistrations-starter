'use strict';

var forEach = require('es5-ext/object/for-each')
  , nest    = require('controller-router/nest');

module.exports = function (path, controller/*, match*/) {
	var routes = nest(path, controller, arguments[2])
	  , rootLength = path.split('/').length;
	forEach(routes, function (conf) {
		var redirectUrl = conf.redirectUrl;
		if (!redirectUrl) return;
		conf.redirectUrl = function () {
			var nestedUrl;
			if (typeof redirectUrl === 'function') {
				nestedUrl = redirectUrl.call(this);
				if (!nestedUrl) return;
			} else {
				nestedUrl = redirectUrl;
			}
			return '/' + this.path.split('/').slice(0, rootLength).join('/') + nestedUrl;
		};
	});
	return routes;
};
