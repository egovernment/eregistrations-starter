'use strict';

var receiver = require('dbjs-persistence/lib/receiver')
  , parse    = require('url3/parse');

module.exports = function (routesMap) {
	var db = require('mano').db;
	receiver('postRequest', function (data) {
		var user = db.User.getById(data.env.userId), businessProcess = null;
		if (user && ['user', 'manager'].some(function (role) {
				return role === user.currentRoleResolved;
			})) {
			businessProcess = user.currentBusinessProcess;
		}
		var env = { user: (user && (user.currentRoleResolved === 'manager')
				&& user.currentlyManagedUser) || user,
			manager: (user && user.currentRoleResolved === 'manager') ? user : null,
			businessProcess: businessProcess,
				action: parse(data.env.url, true) }
		  , routes = routesMap[data.appName];
		if (!routes) return { statusCode: 404 };
		return routes.call(env, data.body, data.referer);
	});
};
