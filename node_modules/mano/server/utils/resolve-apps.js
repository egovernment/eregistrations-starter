'use strict';

var compact       = require('es5-ext/array/#/compact')
  , flatten       = require('es5-ext/array/#/flatten')
  , ensureString  = require('es5-ext/object/validate-stringifiable-value')
  , primitiveSet  = require('es5-ext/object/primitive-set')
  , resolveModule = require('cjs-module/resolve')
  , path          = require('path')
  , readdir       = require('fs2/readdir')

  , join = path.join, resolve = path.resolve;

var ignored = primitiveSet('bin', 'common', 'css', 'data', 'docs', 'documentation', 'examples',
	'log', 'meta', 'model', 'node_modules', 'scripts', 'test', 'tmp', 'uploads', 'view');

var scanDir = function (path) {
	return readdir(path, { type: { directory: true } }).map(function (dirName) {
		var dirPath;
		if (dirName[0] === '.') return;
		if (ignored[dirName]) return;
		dirPath = resolve(path, dirName);
		return resolveModule(dirPath, './mano')(function (result) {
			if (result) return dirName;
			return scanDir(dirPath).map(function (subDirName) { return join(dirName, subDirName); });
		});
	}).invoke(flatten).invoke(compact);
};

module.exports = function (root) { return scanDir(resolve(ensureString(root))); };
