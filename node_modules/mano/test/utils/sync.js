'use strict';

var Db       = require('dbjs')
  , ee       = require('event-emitter')
  , nextTick = require('next-tick');

module.exports = function (t, a, d) {
	var remote = ee(), sync, obj, count = 0, data = [], confirmed = [], preEvent
	  , Sync = t;

	sync = new Sync(remote);
	obj = new Db();

	sync.update(obj._lastOwnEvent_);
	obj.get('foo').value = 'raz';
	sync.update(obj._foo._lastOwnEvent_);

	remote.connection = { send: function (type, str) {
		data.push(str);
		return ++count;
	} };

	remote.confirm = function (id, event) { confirmed.push([id, event]); };

	remote.emit('connect');
	nextTick(function () {
		a(count, 1, "Data sent");
		a.deep(data[0], [String(obj._lastOwnEvent_),
			String(preEvent = obj._foo._lastOwnEvent_)],
			"Data");
		data.length = 0;
		a(confirmed.length, 0, "Confirmed");
		confirmed.length = 0;

		obj.foo = 'dwa';
		sync.update(obj._foo._lastOwnEvent_);
		nextTick(function () {
			a(count, 2, "Update: Data sent");
			a.deep(data[0], [String(obj._lastOwnEvent_),
				String(obj.$foo._lastOwnEvent_)],
				"Update: Data");
			data.length = 0;
			a(confirmed.length, 0, "Update: Confirmed");
			confirmed.length = 0;

			sync.confirm(1);
			a(confirmed.length, 2, "Confirm: Confirmed: Length");
			a.deep(confirmed[0], [obj.__id__, obj._lastOwnEvent_],
				"Confirm: Confirmed: Content #1");
			a.deep(confirmed[1], [obj._foo.__id__, preEvent],
				"Confirm: Confirmed: Content #2");
			confirmed.length = 0;

			remote.emit('connect');
			nextTick(function () {
				a(count, 3, "Reconnect: Data sent");
				a.deep(data[0], [String(obj._foo._lastOwnEvent_)],
					"Reconnect: Data");
				data.length = 0;
				a(confirmed.length, 0, "Reconnect: Confirmed");
				confirmed.length = 0;

				sync.remove(obj._foo.__id__);
				sync.remove(obj.__id__);
				nextTick(function () {
					a(count, 4, "Remove: Data sent");
					a.deep(data[0], ['-' + obj._foo.__id__, '-' + obj.__id__],
						"Remvoe: Data");
					data.length = 0;
					a(confirmed.length, 0, "Remove: Confirmed");
					confirmed.length = 0;

					sync.confirm(4);
					a(confirmed.length, 2, "Remove Confirm: Confirmed: Length");
					a.deep(confirmed[0], [obj._foo.__id__, null],
						"Reove Confirm: Confirmed: Content #1");
					a.deep(confirmed[1], [obj.__id__, null],
						"Remove Confirm: Confirmed: Content #2");
					confirmed.length = 0;
					d();
				});
			});
		});
	});
};
