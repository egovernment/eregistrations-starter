'use strict';

var customError = require('es5-ext/error/custom')
  , _           = require('mano').i18n.bind('authentication')
  , dbjsSave    = require('mano/lib/utils/dbjs-form-save')
  , hash        = require('../../hash');

exports.submit = function (data) {
	var user = this.user;
	if (!user) throw customError("No user authenticated", 'NO_USER');

	return hash.compare(data.password, user.password)(function (isOK) {
		if (!isOK) {
			throw customError('Invalid current password', 'INVALID_PASSWORD', { statusCode: 403 });
		}
		if (data.password === data['password-new']) {
			throw customError(_("New password is same as old one"), 'SAME_PASSWORD', { statusCode: 403 });
		}
		return hash.hash(data['password-new'])(function (password) {
			dbjsSave(data);
			user.password = password;
			return { message: _("Password successfully changed") };
		});
	});
};
