'use strict';

var customError = require('es5-ext/error/custom')
  , promisify   = require('deferred').promisify
  , bcrypt      = require('bcrypt')
  , _           = require('mano').i18n.bind('authentication')
  , dbjsSave    = require('mano/lib/utils/dbjs-form-save')

  , compare = promisify(bcrypt.compare)
  , genSalt = promisify(bcrypt.genSalt), hash = promisify(bcrypt.hash);

exports.submit = function (data) {
	var user = this.user;
	if (!user) throw customError("No user authenticated", 'NO_USER');

	return compare(data.password, user.password)(function (isOK) {
		if (!isOK) {
			throw customError('Invalid current password', 'INVALID_PASSWORD', { statusCode: 403 });
		}
		if (data.password === data['password-new']) {
			throw customError(_("New password is same as old one"), 'SAME_PASSWORD', { statusCode: 403 });
		}
		return hash(data['password-new'], genSalt())(function (password) {
			dbjsSave(data);
			user.password = password;
			return { message: _("Password successfully changed") };
		});
	});
};
