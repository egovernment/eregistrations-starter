'use strict';

var customError  = require('es5-ext/error/custom')
  , Client       = require('mano/lib/server/client')
  , authenticate = require('mano-auth/server/authentication').authenticate
  , mano         = require('mano')

  , _ = mano.i18n.bind('authentication');

exports.submit = function (data) {
	return authenticate(data.email, data.password, this.req, this.res)(function (userId) {
		if (!userId) {
			throw customError(_('Wrong email or password'), 'BAD_CREDENTIALS', { statusCode: 401 });
		}
		if (this.req.isHtmlServerRendered) return;
		return Client.get(this.req)(function (client) { return { inSync: client.isSync }; });
	}.bind(this));
};
