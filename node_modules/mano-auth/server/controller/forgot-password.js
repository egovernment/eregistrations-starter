'use strict';

var last       = require('es5-ext/string/#/last')
  , template   = require('es6-template-strings')
  , genId      = require('time-uuid')
  , User       = require('mano').db.User
  , mailer     = require('mano/lib/server/mailer')
  , origin     = require('mano').env.url
  , _          = require('mano').i18n.bind('authentication')

  , message = { message: _("Password information sent") }
  , defaults, getUrl;

if (origin == null) throw new Error("Url not set in env.json");
if (last.call(origin) === '/') origin = String(origin).slice(0, -1);

defaults = {
	subject: _("Password information"),
	text: _("To reset your password please visit: ${url}")
};

getUrl = function (user) {
	return origin + '/reset-password/?token=' + user.forgotPasswordToken;
};

module.exports = function (data) {
	var user = User.find('email', data.email).last;
	if (!user) return message;

	user.forgotPasswordToken = genId();

	mailer({
		to: user.email,
		subject: defaults.subject,
		text: template(defaults.text, { url: getUrl(user) })
	}).done(null, function (err) {
		console.log("Cannot send email", err.stack);
	});
	return message;
};
