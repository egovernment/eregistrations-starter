'use strict';

var customError = require('es5-ext/error/custom')
  , promisify   = require('deferred').promisify
  , bcrypt      = require('bcrypt')
  , db          = require('mano').db

  , compare = promisify(bcrypt.compare)
  , genSalt = promisify(bcrypt.genSalt), hash = promisify(bcrypt.hash)
  , Sha256Hash = db.Sha256Hash;

exports.validate = {
	password:       Sha256Hash,
	'password-new': Sha256Hash
};

exports.controller = function (data, env) {
	var user = env.user;
	if (!user) throw customError("No user authenticated", 'NO_USER');

	return compare(data.password, user.password)(function (isOK) {
		if (!isOK) {
			throw customError('Invalid current password', 'INVALID_PASSWORD',
				{ statusCode: 400 });
		}
		return hash(data['password-new'], genSalt())(function (password) {
			user.password = password;
			return { message: "Password successfully changed" };
		});
	});
};
