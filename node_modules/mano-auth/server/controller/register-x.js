'use strict';

var promisify    = require('deferred').promisify
  , bcrypt       = require('bcrypt')
  , db           = require('mano').db
  , dbjsCreate   = require('mano/lib/utils/dbjs-form-create')
  , dbjsValidate = require('mano/lib/utils/dbjs-form-validate')

  , genSalt = promisify(bcrypt.genSalt), hash = promisify(bcrypt.hash)
  , Sha256Hash = db.Sha256Hash;

exports.validate = function (data) {
	dbjsValidate(data, { assure: ['User#/email'], partial: true });
	Sha256Hash.validate(data['User#/password']);
};

exports.controller = function (data) {
	return hash(data['User#/password'], genSalt())(function (password) {
		data['User#/password'] = password;
		return dbjsCreate(data);
	});
};
