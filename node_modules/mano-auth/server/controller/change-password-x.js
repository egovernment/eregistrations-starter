'use strict';

var customError = require('es5-ext/error/custom')
  , endsWith    = require('es5-ext/string/#/ends-with')
  , some        = require('es5-ext/object/some')
  , promisify   = require('deferred').promisify
  , bcrypt      = require('bcrypt')
  , db          = require('mano').db

  , keys = Object.keys
  , genSalt = promisify(bcrypt.genSalt), hash = promisify(bcrypt.hash)
  , sha256Hash = db.Sha256Hash;

exports.validate = function (data) {
	if (!some(data, function (value, name) {
			if (endsWith.call(name, '/password')) {
				sha256Hash.validate(value);
				return true;
			}
			return false;
		})) {
		throw customError("Missing value", "NO_PASSWORD", { statusCode: 400 });
	}
};

exports.controller = function (data) {
	var user, relId;
	keys(data).some(function (name) {
		if (endsWith.call(name, '/password')) {
			relId = name;
			return true;
		}
		return false;
	});

	user = db.objects.unserialize(relId).object;
	return hash(data[relId], genSalt())(function (password) {
		user.password = password;
		return { message: "Password successfully changed" };
	});
};
