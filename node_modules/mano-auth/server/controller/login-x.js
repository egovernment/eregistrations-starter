'use strict';

var customError  = require('es5-ext/error/custom')
  , db           = require('mano').db
  , Client       = require('mano/lib/server/client')
  , authenticate = require('mano-auth/server/authentication').authenticate
  , mano         = require('mano')

  , _ = mano.i18n.bind('authentication');

exports.validate = {
	email: db.Email,
	password: db.Sha256Hash
};

exports.controller = function (data, env) {
	return authenticate(data.email, data.password, this.req, this.res)(function (userId) {
		if (!userId) {
			throw customError(_('Wrong email or password'), 'BAD_CREDENTIALS', { statusCode: 401 });
		}
		if (this.req.isHtmlServerRendered) return;
		return Client.get(this.req)(function (client) {
			return { url: '/', reload: true, inSync: client.isSync };
		});
	}.bind(this));
};
