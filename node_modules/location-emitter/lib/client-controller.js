'use strict';

var assign         = require('es5-ext/object/assign')
  , forEach        = require('es5-ext/object/for-each')
  , gatherFormData = require('router/lib/gather-form-data')
  , qs             = require('querystring2')

  , isExt = RegExp.prototype.test.bind(/\.[a-zA-Z0-9]+$/)
  , isArray = Array.isArray;

module.exports = function (location/*, filterPattern*/) {
	var window = location.window
	  , document = window.document
	  , ahref = document.createElement('a')

	  , filterPattern;

	var isExternal = function (ahref, target) {
		if (!ahref || !ahref.href) return true;
		if (ahref.protocol && (ahref.protocol !== ':') && (ahref.protocol !== location.protocol)) {
			return true;
		}
		if (ahref.host && (ahref.host !== location.host)) return true;
		if (target.getAttribute('rel') === 'server') return true;
		if (target.getAttribute('target') === '_blank') return true;
		if (filterPattern && filterPattern.test(ahref.href)) return true;
	};

	filterPattern = arguments[1];
	if (filterPattern != null) (filterPattern = RegExp(filterPattern));

	document.addEventListener('click', function (event) {
		var el;
		if (event.metaKey || event.ctrlKey || (event.which === 2) ||
				(event.which === 3)) {
			return;
		}

		el = event.target;
		while (el && (el.nodeName.toLowerCase() !== 'a')) (el = el.parentNode);

		if (isExternal(el, el)) return;
		if (isExt(el.href)) return;

		event.preventDefault();
		location.goto(el.href);
	}, false);

	document.addEventListener('submit', function (event) {
		var form = event.target, data, method = form.getAttribute('method');
		if (method && (method.toLowerCase() === 'post')) return;

		ahref.href = form.getAttribute('action');
		if (isExternal(ahref, form)) return;

		event.preventDefault();

		data = gatherFormData(form);

		forEach(data, function (value, key) {
			if (!value) delete data[key];
			if (isArray(value)) {
				data[key] = value = value.filter(Boolean);
				if (!value.length) delete data[key];
			}
		});

		data = qs.encode(assign(qs.decode(ahref.search.slice(1)), data));
		if (data) ahref.search = data;
		else ahref.href = ahref.protocol + '//' + ahref.host + ahref.pathname;
		location.goto(ahref.href);
	}, false);

	window.addEventListener('hashchange', location.onchange, false);
};
