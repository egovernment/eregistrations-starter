'use strict';

var clear           = require('es5-ext/object/clear')
  , assign          = require('es5-ext/object/assign')
  , forEach         = require('es5-ext/object/for-each')
  , d               = require('d')
  , parse           = require('querystring2/parse')
  , ObservableValue = require('observable-value')

  , defineProperties = Object.defineProperties
  , propertyIsEnumerable = Object.prototype.propertyIsEnumerable
  , Query;

Query = module.exports = function (location) {
	var mutables = Object.create(null);
	assign(this, parse(location.search.slice(1)));
	location.on('change', function () {
		assign(clear(this), parse(location.search.slice(1)));
		forEach(mutables, function (mutable, name) {
			mutable.value = propertyIsEnumerable.call(this, name) ? this[name] : null;
		}, this);
	}.bind(this));
	defineProperties(this, {
		get: d(function (name) {
			if (mutables[name]) return mutables[name];
			return (mutables[name] =
				new ObservableValue(propertyIsEnumerable.call(this, name)
					? this[name]
					: null));
		}.bind(this)),
		toString: d(function () {
			return location.search.slice(1);
		})
	});
};

Query.prototype = Object.create(null);
