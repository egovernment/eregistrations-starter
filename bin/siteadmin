#!/usr/bin/env node

'use strict';

var promisify  = require('deferred').promisify
  , i18n       = require('i18n2')
  , bcrypt     = require('bcrypt')
  , mano       = require('mano')
  , db         = mano.db
  , Email      = require('dbjs-ext/string/string-line/email')(db)
  , Password   = require('dbjs-ext/string/string-line/password')(db)
  , hashPass   = require('mano-auth/utils/client-hash')
  , User       = require('mano-auth/model/user')(db)
  , loadData   = require('mano/scripts/load-data')
  , tryRequire = require('mano/lib/utils/try-require').bind(require)
  , resolve    = require('path').resolve
  , stdout     = process.stdout.write.bind(process.stdout)
  , program    = require('commander')

  , genSalt = promisify(bcrypt.genSalt), hash = promisify(bcrypt.hash)
  , dbServer, promptEmail, promptPassword;

promptEmail = function () {
	program.prompt('SiteAdmin email: ', function (value) {
		value = value.trim();
		try { Email.validate(value); } catch (error) {
			console.log(error.message);
			promptEmail();
			return;
		}
		promptPassword(value);
	});
};

promptPassword = function (email) {
	program.prompt(email + ' password: ', function (value) {
		value = value.trim();
		try { Password.validate(value); } catch (error) {
			console.log(error.message);
			promptPassword(email);
			return;
		}
		hash(hashPass(email, value), genSalt())(function (password) {
			return new User({ email: email, password:
				password, roles: ['site-admin'] });
		}).done(function () {
			setTimeout(function () {
				dbServer.close(function () {
					console.log("Siteadmin user succesfully created. To be able to" +
						" login with siteadmin, server needs to be restarted");
				}).done();
			}, 500);
		});
	});
};

console.log("!!! Make sure application server is down, before you proceed !!!");
console.log("Reasoning: Adding Site Admin account using this script will not automatically");
console.log("add Site Admin to running application process. Application process needs to be");
console.log("restarted afterwars, then it'll be loaded into database memory");

mano.i18n = i18n(tryRequire(resolve(__dirname, '../i18n')));
loadData(resolve(__dirname, '..'), stdout).done(function (mongo) {
	dbServer = mongo;
	require('../user/server/db/mongo');
	promptEmail();
});
